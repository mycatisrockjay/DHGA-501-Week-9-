# -*- coding: utf-8 -*-
"""2025.11.9è¥¿å—è”å¤§å†…è¿.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1oF3oN8arZX3xPqX9mk2ec96WhnilCCDt
"""

import pandas as pd
import folium

# è¯»å–æ•°æ®
url = "/content/è¥¿å—è”å¤§å†…è¿è·¯çº¿æ•°æ®.csv"  # è¯·æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶è·¯å¾„æˆ–URL
df = pd.read_csv(url)

# åˆ›å»ºåº•å›¾ï¼Œåˆå§‹å®šä½åœ¨ä¸­å›½ä¸­éƒ¨
m = folium.Map(location=[28.0, 106.0], zoom_start=5)

# å®šä¹‰é¢œè‰²æ˜ å°„
color_map = {
    "æµ·é™†å¹¶ç”¨": "blue",
    "æ¹˜é»”æ»‡æ­¥è¡Œå›¢": "red"
}

# æŒ‰é˜Ÿä¼åˆ†ç»„ç»˜åˆ¶è·¯çº¿
for team, group in df.groupby('team'):
    route_name = group['route_name'].iloc[0]
    color = color_map[route_name]

    # æå–è·¯çº¿ç‚¹
    locations = group[['latitude', 'longitude']].values.tolist()

    # ç»˜åˆ¶è·¯çº¿
    folium.PolyLine(
        locations=locations,
        color=color,
        weight=3,
        opacity=0.7,
        tooltip=route_name
    ).add_to(m)

    # ç»˜åˆ¶æ¯ä¸ªåœ°ç‚¹æ ‡è®°
    for _, row in group.iterrows():
        popup_text = f"<b>{row['location_name']}</b><br>æ—¥æœŸ: {row['date']}<br>è¯´æ˜: {row['description']}"
        folium.CircleMarker(
            location=[row['latitude'], row['longitude']],
            radius=6,
            color=color,
            fill=True,
            fill_color=color,
            popup=folium.Popup(popup_text, max_width=300)
        ).add_to(m)

# æ·»åŠ å›¾ä¾‹
legend_html = '''
<div style="position: fixed;
            top: 10px; left: 50px; width: 180px; height: 80px;
            background-color: white; border:2px solid grey; z-index:9999;
            font-size:14px; padding: 10px">
     <p><span style="color: blue;">â—</span> æµ·é™†å¹¶ç”¨</p>
     <p><span style="color: red;">â—</span> æ¹˜é»”æ»‡æ­¥è¡Œå›¢</p>
</div>
'''
m.get_root().html.add_child(folium.Element(legend_html))

# ä¿å­˜ä¸ºHTMLæ–‡ä»¶
m.save('è¥¿å—è”å¤§å†…è¿è·¯çº¿å›¾.html')

# åœ¨Colabä¸­æ˜¾ç¤ºåœ°å›¾
m

import pandas as pd
import folium
from folium.plugins import MeasureControl

# è¯»å–æ•°æ®
url = "/content/è¥¿å—è”å¤§å†…è¿è·¯çº¿æ•°æ®.csv"  # è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…æ•°æ®URL
df = pd.read_csv(url)

# åˆ›å»ºåº•å›¾ï¼Œåˆå§‹ä¸­å¿ƒç‚¹è®¾ä¸ºé•¿æ²™
m = folium.Map(
    location=[28.23, 112.94],
    zoom_start=6,
    tiles='OpenStreetMap'
)

# å®šä¹‰é¢œè‰²æ˜ å°„
color_map = {
    'æµ·é™†å¹¶ç”¨': 'blue',
    'æ¹˜é»”æ»‡æ­¥è¡Œå›¢': 'red'
}

# ä¸ºæ¯æ¡è·¯çº¿åˆ›å»º FeatureGroupï¼Œä¾¿äºæ§åˆ¶æ˜¾ç¤º/éšè—
feature_groups = {}

for route_name in df['route_name'].unique():
    fg = folium.FeatureGroup(name=route_name, show=False)
    feature_groups[route_name] = fg

# æ·»åŠ è·¯çº¿å’Œæ ‡è®°ç‚¹
for idx, row in df.iterrows():
    route_name = row['route_name']
    color = color_map[route_name]

    # åˆ›å»ºæ ¼å¼åŒ–çš„å¼¹å‡ºçª—å£å†…å®¹
    popup_text = f"""
    <div style="
        font-family: Arial, sans-serif;
        min-width: 200px;
        line-height: 1.4;
    ">
        <div style="
            background-color: {color};
            color: white;
            padding: 8px 12px;
            margin: -10px -10px 8px -10px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            font-size: 14px;
        ">
            {row['location_name']}
        </div>
        <div style="padding: 0 5px;">
    """

    if pd.notna(row['date']):
        popup_text += f"""
            <div style="margin: 8px 0;">
                <span style="font-weight: bold; color: #333;">ğŸ“… æ—¥æœŸ:</span><br>
                <span style="color: #666; margin-left: 8px;">{row['date']}</span>
            </div>
        """

    if pd.notna(row['description']):
        popup_text += f"""
            <div style="margin: 8px 0;">
                <span style="font-weight: bold; color: #333;">ğŸ“ æè¿°:</span><br>
                <span style="color: #666; margin-left: 8px;">{row['description']}</span>
            </div>
        """

    popup_text += """
        </div>
    </div>
    """

    # æ·»åŠ åŸå¸‚æ ‡è®°ç‚¹
    folium.CircleMarker(
        location=[row['latitude'], row['longitude']],
        radius=6,
        popup=folium.Popup(popup_text, max_width=300),
        tooltip=row['location_name'],
        color=color,
        fillColor=color,
        fillOpacity=0.7
    ).add_to(feature_groups[route_name])

    # æ·»åŠ è·¯çº¿ï¼ˆè¿æ¥è¿ç»­çš„ç‚¹ï¼‰
    route_df = df[df['route_name'] == route_name].sort_values('sequence')
    locations = list(zip(route_df['latitude'], route_df['longitude']))

    folium.PolyLine(
        locations=locations,
        color=color,
        weight=3,
        opacity=0.7,
        tooltip=route_name
    ).add_to(feature_groups[route_name])

# å°†æ‰€æœ‰ FeatureGroup æ·»åŠ åˆ°åœ°å›¾
for fg in feature_groups.values():
    fg.add_to(m)

# æ·»åŠ å›¾å±‚æ§åˆ¶
folium.LayerControl(collapsed=False).add_to(m)

# æ·»åŠ æµ‹é‡å·¥å…·
m.add_child(MeasureControl())

# ä¿å­˜ä¸º HTML æ–‡ä»¶
m.save('è¥¿å—è”å¤§å†…è¿è·¯çº¿å›¾_æ”¹è¿›.html')

# åœ¨ Colab ä¸­æ˜¾ç¤ºåœ°å›¾
print("åœ°å›¾å·²ç”Ÿæˆï¼ç‚¹å‡»æ ‡è®°ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚")
m

import pandas as pd
import folium
from folium import plugins
import branca.colormap as cm

# è¯»å–æ•°æ®
df = pd.read_csv('/content/è¥¿å—è”å¤§å†…è¿è·¯çº¿æ•°æ®.csv')

# åˆ›å»ºåº•å›¾ï¼Œåˆå§‹å®šä½åœ¨ä¸­å›½ä¸­éƒ¨
m = folium.Map(location=[28.0, 106.0], zoom_start=5)

# å®šä¹‰é¢œè‰²æ˜ å°„
color_map = {
    "æµ·é™†å¹¶ç”¨": "blue",
    "æ¹˜é»”æ»‡æ­¥è¡Œå›¢": "red"
}

# ä¸ºæ¯æ¡è·¯çº¿åˆ›å»ºåŠ¨æ€æ—¶é—´çº¿
for team, group in df.groupby('team'):
    route_name = group['route_name'].iloc[0]
    color = color_map[route_name]

    # æŒ‰sequenceæ’åºç¡®ä¿æ­£ç¡®é¡ºåº
    group = group.sort_values('sequence')

    # æå–è·¯çº¿ç‚¹
    locations = group[['latitude', 'longitude']].values.tolist()

    # ä¸ºæ—¶é—´çº¿åŠŸèƒ½å‡†å¤‡æ•°æ®
    features = []
    for idx, row in group.iterrows():
        feature = {
            'type': 'Feature',
            'geometry': {
                'type': 'Point',
                'coordinates': [row['longitude'], row['latitude']]
            },
            'properties': {
                'time': row['date'] if pd.notna(row['date']) else 'æ—¥æœŸä¸è¯¦',
                'popup': f"<b>{row['location_name']}</b><br>é˜Ÿä¼: {route_name}<br>æ—¥æœŸ: {row['date']}<br>è¯´æ˜: {row['description']}",
                'icon': 'circle',
                'iconstyle': {
                    'fillColor': color,
                    'fillOpacity': 0.8,
                    'stroke': 'true',
                    'radius': 6
                }
            }
        }
        features.append(feature)

    # æ·»åŠ æ—¶é—´çº¿
    plugins.TimestampedGeoJson(
        {
            'type': 'FeatureCollection',
            'features': features
        },
        period='P1M',  # æ—¶é—´é—´éš”ä¸º1ä¸ªæœˆ
        add_last_point=True,
        auto_play=False,
        loop=False,
        max_speed=1,
        loop_button=True,
        date_options='YYYYå¹´MMæœˆ',
        time_slider_drag_update=True,
        duration='P1M'
    ).add_to(m)

    # åŒæ—¶ä¿ç•™é™æ€è·¯çº¿ä½œä¸ºå‚è€ƒ
    folium.PolyLine(
        locations=locations,
        color=color,
        weight=2,
        opacity=0.5,
        tooltip=f"{route_name} (å®Œæ•´è·¯çº¿)",
        dash_array='5'
    ).add_to(m)

# æ·»åŠ å›¾ä¾‹
legend_html = '''
<div style="position: fixed;
            top: 10px; left: 50px; width: 200px; height: 90px;
            background-color: white; border:2px solid grey; z-index:9999;
            font-size:14px; padding: 10px; border-radius: 5px;">
     <p style="margin: 2px 0;"><span style="color: blue;">â—</span> æµ·é™†å¹¶ç”¨</p>
     <p style="margin: 2px 0;"><span style="color: red;">â—</span> æ¹˜é»”æ»‡æ­¥è¡Œå›¢</p>
     <p style="margin: 5px 0; font-size: 12px; color: #666;">ä½¿ç”¨æ—¶é—´è½´æ§ä»¶æ’­æ”¾åŠ¨ç”»</p>
</div>
'''
m.get_root().html.add_child(folium.Element(legend_html))

# æ·»åŠ æ ‡é¢˜
title_html = '''
             <h3 align="center" style="font-size:16px; margin: 0; padding: 5px;">
             <b>è¥¿å—è”å¤§å†…è¿è·¯çº¿åŠ¨æ€å›¾ (1938å¹´)</b></h3>
             '''
m.get_root().html.add_child(folium.Element(title_html))

# ä¿å­˜ä¸ºHTMLæ–‡ä»¶
m.save('/content/è¥¿å—è”å¤§å†…è¿åŠ¨æ€è·¯çº¿å›¾.html')

print("åŠ¨æ€è·¯çº¿å›¾å·²ç”Ÿæˆï¼æ–‡ä»¶ä¿å­˜åœ¨ï¼š/content/è¥¿å—è”å¤§å†…è¿åŠ¨æ€è·¯çº¿å›¾.html")
print("ä½¿ç”¨åœ°å›¾å·¦ä¸‹è§’çš„æ—¶é—´è½´æ§ä»¶å¯ä»¥æ’­æ”¾è·¯çº¿åŠ¨ç”»")

# åœ¨Colabä¸­æ˜¾ç¤ºåœ°å›¾
m